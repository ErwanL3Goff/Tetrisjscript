<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .tetris-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
        }
        .game-board {
            border: 2px solid #4a5568;
            background-color: #1a202c;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .piece-I { background-color: #00f5ff; }
        .piece-J { background-color: #0000ff; }
        .piece-L { background-color: #ffa500; }
        .piece-O { background-color: #ffff00; }
        .piece-S { background-color: #00ff00; }
        .piece-T { background-color: #800080; }
        .piece-Z { background-color: #ff0000; }
        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }
        .next-piece {
            background-color: #2d3748;
            border-radius: 5px;
            padding: 10px;
        }
        .controls {
            background-color: #2d3748;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .key {
            display: inline-block;
            background-color: #4a5568;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .player-title {
            text-shadow: 0 0 10px currentColor;
        }
        .player-1 .player-title { color: #ff6b6b; }
        .player-2 .player-title { color: #4ecdc4; }
        .game-over {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
        .flash {
            animation: flash 0.5s infinite alternate;
        }
        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <h1 class="text-4xl mb-6 text-center">TETRIS MULTIJOUEUR</h1>
    
    <div class="flex flex-col md:flex-row gap-8 w-full max-w-6xl">
        <!-- Joueur 1 -->
        <div class="tetris-container player-1 flex-1">
            <h2 class="text-xl mb-4 text-center player-title">JOUEUR 1</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex flex-col">
                    <canvas id="board1" class="game-board" width="300" height="600"></canvas>
                    <div class="controls mt-4">
                        <h3 class="text-sm mb-2">CONTROLES</h3>
                        <div>
                            <span class="key">S</span> Gauche
                            <span class="key">D</span> Droite
                            <span class="key">Z</span> Rotation
                            <span class="key">Q</span> Descente
                        </div>
                    </div>
                </div>
                <div class="flex flex-col">
                    <div class="next-piece mb-4">
                        <h3 class="text-sm mb-2">PROCHAINE PIÈCE</h3>
                        <canvas id="next1" width="120" height="120"></canvas>
                    </div>
                    <div class="stats bg-gray-800 p-4 rounded">
                        <div class="mb-2">Score: <span id="score1">0</span></div>
                        <div class="mb-2">Lignes: <span id="lines1">0</span></div>
                        <div>Niveau: <span id="level1">1</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contrôles du jeu -->
        <div class="tetris-container flex flex-col items-center justify-center w-full md:w-64">
            <h2 class="text-xl mb-4 text-center">CONTRÔLES</h2>
            <div class="mb-6 text-center">
                <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mb-2 w-full">
                    DÉMARRER
                </button>
                <button id="pauseBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mb-2 w-full">
                    PAUSE
                </button>
                <button id="resetBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded w-full">
                    RECOMMENCER
                </button>
            </div>
            <div class="mb-4 text-center">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="twoPlayers" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="ml-2">2 Joueurs</span>
                </label>
            </div>
            <div class="text-sm text-center">
                <p>Le jeu s'accélère à chaque niveau.</p>
                <p class="mt-2">Effacez des lignes pour marquer des points!</p>
            </div>
        </div>
        
        <!-- Joueur 2 -->
        <div class="tetris-container player-2 flex-1">
            <h2 class="text-xl mb-4 text-center player-title">JOUEUR 2</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex flex-col">
                    <canvas id="board2" class="game-board" width="300" height="600"></canvas>
                    <div class="controls mt-4">
                        <h3 class="text-sm mb-2">CONTROLES</h3>
                        <div>
                            <span class="key">←</span> Gauche
                            <span class="key">→</span> Droite
                            <span class="key">↑</span> Rotation
                            <span class="key">↓</span> Descente
                        </div>
                    </div>
                </div>
                <div class="flex flex-col">
                    <div class="next-piece mb-4">
                        <h3 class="text-sm mb-2">PROCHAINE PIÈCE</h3>
                        <canvas id="next2" width="120" height="120"></canvas>
                    </div>
                    <div class="stats bg-gray-800 p-4 rounded">
                        <div class="mb-2">Score: <span id="score2">0</span></div>
                        <div class="mb-2">Lignes: <span id="lines2">0</span></div>
                        <div>Niveau: <span id="level2">1</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de fin de jeu -->
    <div id="gameOver" class="fixed inset-0 game-over hidden flex items-center justify-center">
        <div class="bg-gray-900 p-8 rounded-lg text-center max-w-md">
            <h2 class="text-2xl mb-4 text-red-500 flash">GAME OVER</h2>
            <p id="winnerText" class="mb-6"></p>
            <button id="restartBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                RECOMMENCER
            </button>
        </div>
    </div>

    <script>
        // Configuration du jeu
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        
        // Définition des pièces Tetris avec leurs couleurs
        const PIECES = [
            { 
                shape: [
                    [0, 0, 0, 0],
                    [1, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0]
                ],
                color: 'piece-I'
            },
            {
                shape: [
                    [1, 0, 0],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                color: 'piece-J'
            },
            {
                shape: [
                    [0, 0, 1],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                color: 'piece-L'
            },
            {
                shape: [
                    [1, 1],
                    [1, 1]
                ],
                color: 'piece-O'
            },
            {
                shape: [
                    [0, 1, 1],
                    [1, 1, 0],
                    [0, 0, 0]
                ],
                color: 'piece-S'
            },
            {
                shape: [
                    [0, 1, 0],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                color: 'piece-T'
            },
            {
                shape: [
                    [1, 1, 0],
                    [0, 1, 1],
                    [0, 0, 0]
                ],
                color: 'piece-Z'
            }
        ];

        // Classe principale du jeu Tetris
        class Tetris {
            constructor(canvasId, nextCanvasId, scoreId, linesId, levelId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.nextCanvas = document.getElementById(nextCanvasId);
                this.nextCtx = this.nextCanvas.getContext('2d');
                this.scoreElement = document.getElementById(scoreId);
                this.linesElement = document.getElementById(linesId);
                this.levelElement = document.getElementById(levelId);
                
                this.board = this.createBoard();
                this.piece = this.getRandomPiece();
                this.nextPiece = this.getRandomPiece();
                this.score = 0;
                this.lines = 0;
                this.level = 1;
                this.gameOver = false;
                this.isPaused = false;
                this.dropCounter = 0;
                this.dropInterval = 1000; // 1 seconde initialement
                
                // Ajuster la taille des canvas
                this.ctx.scale(BLOCK_SIZE, BLOCK_SIZE);
                this.nextCtx.scale(BLOCK_SIZE, BLOCK_SIZE);
                
                this.draw();
            }
            
            createBoard() {
                return Array.from({ length: ROWS }, () => Array(COLS).fill(0));
            }
            
            getRandomPiece() {
                const piece = JSON.parse(JSON.stringify(PIECES[Math.floor(Math.random() * PIECES.length)]));
                piece.x = Math.floor(COLS / 2) - Math.floor(piece.shape[0].length / 2);
                piece.y = 0;
                return piece;
            }
            
            draw() {
                // Effacer le canvas
                this.ctx.fillStyle = '#1a202c';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Dessiner le plateau
                this.drawBoard();
                
                // Dessiner la pièce actuelle
                this.drawPiece(this.piece);
                
                // Dessiner la prochaine pièce
                this.nextCtx.fillStyle = '#2d3748';
                this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);
                this.drawPiece(this.nextPiece, this.nextCtx, 1, 1);
            }
            
            drawBoard() {
                this.board.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            this.ctx.fillStyle = this.getColorClass(value);
                            this.ctx.fillRect(x, y, 1, 1);
                        }
                    });
                });
            }
            
            drawPiece(piece, context = this.ctx, offsetX = 0, offsetY = 0) {
                piece.shape.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            context.fillStyle = this.getColorClass(piece.color);
                            context.fillRect(x + piece.x + offsetX, y + piece.y + offsetY, 1, 1);
                        }
                    });
                });
            }
            
            getColorClass(color) {
                // Convertir le nom de classe en couleur hexadécimale
                const colorMap = {
                    'piece-I': '#00f5ff',
                    'piece-J': '#0000ff',
                    'piece-L': '#ffa500',
                    'piece-O': '#ffff00',
                    'piece-S': '#00ff00',
                    'piece-T': '#800080',
                    'piece-Z': '#ff0000'
                };
                return colorMap[color] || '#ffffff';
            }
            
            movePiece(dir) {
                if (this.isPaused || this.gameOver) return;
                
                this.piece.x += dir;
                if (this.collision()) {
                    this.piece.x -= dir;
                }
            }
            
            rotatePiece() {
                if (this.isPaused || this.gameOver) return;
                
                const originalShape = this.piece.shape;
                // Transposer la matrice (rotation)
                const rotated = this.piece.shape[0].map((_, index) =>
                    this.piece.shape.map(row => row[index]).reverse()
                );
                
                this.piece.shape = rotated;
                if (this.collision()) {
                    this.piece.shape = originalShape;
                }
            }
            
            dropPiece() {
                if (this.isPaused || this.gameOver) return;
                
                this.piece.y += 1;
                if (this.collision()) {
                    this.piece.y -= 1;
                    this.lockPiece();
                    this.clearLines();
                    this.piece = this.nextPiece;
                    this.nextPiece = this.getRandomPiece();
                    
                    // Vérifier si le jeu est terminé
                    if (this.collision()) {
                        this.gameOver = true;
                    }
                }
                this.dropCounter = 0;
            }
            
            collision() {
                return this.piece.shape.some((row, y) => {
                    return row.some((value, x) => {
                        return value !== 0 &&
                            (this.board[y + this.piece.y] &&
                            this.board[y + this.piece.y][x + this.piece.x]) !== 0;
                    });
                });
            }
            
            lockPiece() {
                this.piece.shape.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value !== 0) {
                            this.board[y + this.piece.y][x + this.piece.x] = this.piece.color;
                        }
                    });
                });
            }
            
            clearLines() {
                let linesCleared = 0;
                
                this.board.forEach((row, y) => {
                    if (row.every(value => value !== 0)) {
                        // Supprimer la ligne
                        this.board.splice(y, 1);
                        // Ajouter une nouvelle ligne vide en haut
                        this.board.unshift(Array(COLS).fill(0));
                        linesCleared++;
                    }
                });
                
                if (linesCleared > 0) {
                    // Mettre à jour le score
                    this.lines += linesCleared;
                    this.score += this.calculateScore(linesCleared);
                    
                    // Mettre à jour le niveau
                    this.level = Math.floor(this.lines / 10) + 1;
                    this.dropInterval = 1000 - (this.level - 1) * 100;
                    if (this.dropInterval < 100) this.dropInterval = 100;
                    
                    // Mettre à jour l'interface
                    this.updateStats();
                }
            }
            
            calculateScore(lines) {
                const baseScores = [0, 40, 100, 300, 1200];
                return baseScores[lines] * this.level;
            }
            
            updateStats() {
                this.scoreElement.textContent = this.score;
                this.linesElement.textContent = this.lines;
                this.levelElement.textContent = this.level;
            }
            
            update(deltaTime) {
                if (this.isPaused || this.gameOver) return;
                
                this.dropCounter += deltaTime;
                if (this.dropCounter > this.dropInterval) {
                    this.dropPiece();
                }
                
                this.draw();
            }
            
            reset() {
                this.board = this.createBoard();
                this.piece = this.getRandomPiece();
                this.nextPiece = this.getRandomPiece();
                this.score = 0;
                this.lines = 0;
                this.level = 1;
                this.gameOver = false;
                this.isPaused = false;
                this.dropInterval = 1000;
                this.updateStats();
                this.draw();
            }
            
            pause() {
                this.isPaused = !this.isPaused;
            }
        }

        // Gestion du jeu principal
        let game1, game2;
        let twoPlayers = false;
        let lastTime = 0;
        let animationId;

        function init() {
            game1 = new Tetris('board1', 'next1', 'score1', 'lines1', 'level1');
            game2 = new Tetris('board2', 'next2', 'score2', 'lines2', 'level2');
            
            // Masquer le jeu du joueur 2 initialement
            document.querySelector('.player-2').classList.add('hidden');
            
            // Événements des boutons
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('resetBtn').addEventListener('click', resetGame);
            document.getElementById('restartBtn').addEventListener('click', resetGame);
            document.getElementById('twoPlayers').addEventListener('change', toggleTwoPlayers);
            
            // Événements du clavier
            document.addEventListener('keydown', handleKeyPress);
        }

        function startGame() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            lastTime = 0;
            animationId = requestAnimationFrame(update);
        }

        function update(time = 0) {
            const deltaTime = time - lastTime;
            lastTime = time;
            
            game1.update(deltaTime);
            if (twoPlayers) {
                game2.update(deltaTime);
                
                // Vérifier si un des joueurs a perdu
                if (game1.gameOver || game2.gameOver) {
                    endGame();
                    return;
                }
            } else if (game1.gameOver) {
                endGame();
                return;
            }
            
            animationId = requestAnimationFrame(update);
        }

        function togglePause() {
            game1.pause();
            if (twoPlayers) {
                game2.pause();
            }
        }

        function resetGame() {
            cancelAnimationFrame(animationId);
            game1.reset();
            game2.reset();
            document.getElementById('gameOver').classList.add('hidden');
            startGame();
        }

        function toggleTwoPlayers() {
            twoPlayers = document.getElementById('twoPlayers').checked;
            const player2Element = document.querySelector('.player-2');
            
            if (twoPlayers) {
                player2Element.classList.remove('hidden');
            } else {
                player2Element.classList.add('hidden');
            }
            
            resetGame();
        }

        function endGame() {
            cancelAnimationFrame(animationId);
            
            let winnerText = '';
            if (twoPlayers) {
                if (game1.gameOver && game2.gameOver) {
                    if (game1.score > game2.score) {
                        winnerText = 'Le joueur 1 gagne avec ' + game1.score + ' points!';
                    } else if (game2.score > game1.score) {
                        winnerText = 'Le joueur 2 gagne avec ' + game2.score + ' points!';
                    } else {
                        winnerText = 'Match nul! Les deux joueurs ont ' + game1.score + ' points.';
                    }
                } else if (game1.gameOver) {
                    winnerText = 'Le joueur 2 gagne avec ' + game2.score + ' points!';
                } else {
                    winnerText = 'Le joueur 1 gagne avec ' + game1.score + ' points!';
                }
            } else {
                winnerText = 'Game Over! Votre score: ' + game1.score;
            }
            
            document.getElementById('winnerText').textContent = winnerText;
            document.getElementById('gameOver').classList.remove('hidden');
        }

        function handleKeyPress(event) {
            if (event.key === 'q' || event.key === 'Q') {
                // Joueur 1 - Gauche
                game1.movePiece(-1);
            } else if (event.key === 'd' || event.key === 'D') {
                // Joueur 1 - Droite
                game1.movePiece(1);
            } else if (event.key === 'z' || event.key === 'Z') {
                // Joueur 1 - Rotation
                game1.rotatePiece();
            } else if (event.key === 's' || event.key === 'S') {
                // Joueur 1 - Descente
                game1.dropPiece();
            }
            
            if (twoPlayers) {
                if (event.key === 'ArrowLeft') {
                    // Joueur 2 - Gauche
                    game2.movePiece(-1);
                } else if (event.key === 'ArrowRight') {
                    // Joueur 2 - Droite
                    game2.movePiece(1);
                } else if (event.key === 'ArrowUp') {
                    // Joueur 2 - Rotation
                    game2.rotatePiece();
                } else if (event.key === 'ArrowDown') {
                    // Joueur 2 - Descente
                    game2.dropPiece();
                }
            }
        }

        // Initialiser le jeu au chargement de la page
        window.addEventListener('load', init);
    </script>
</body>
</html>